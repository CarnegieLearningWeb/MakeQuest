!function(o){"object"==typeof exports&&"object"==typeof module?o(require("../../lib/codemirror"),require("./foldcode")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./foldcode"],o):o(CodeMirror)}(function(o){"use strict";function t(o){this.options=o,this.from=this.to=0}function e(o){return o===!0&&(o={}),null==o.gutter&&(o.gutter="CodeMirror-foldgutter"),null==o.indicatorOpen&&(o.indicatorOpen="CodeMirror-foldgutter-open"),null==o.indicatorFolded&&(o.indicatorFolded="CodeMirror-foldgutter-folded"),o}function r(o,t){for(var e=o.findMarksAt(c(t)),r=0;r<e.length;++r)if(e[r].__isFold&&e[r].find().from.line==t)return e[r]}function n(o){if("string"==typeof o){var t=document.createElement("div");return t.className=o+" CodeMirror-guttermarker-subtle",t}return o.cloneNode(!0)}function i(o,t,e){var i=o.state.foldGutter.options,f=t,d=o.foldOption(i,"minFoldSize"),a=o.foldOption(i,"rangeFinder");o.eachLine(t,e,function(t){var e=null;if(r(o,f))e=n(i.indicatorFolded);else{var u=c(f,0),l=a&&a(o,u);l&&l.to.line-l.from.line>=d&&(e=n(i.indicatorOpen))}o.setGutterMarker(t,i.gutter,e),++f})}function f(o){var t=o.getViewport(),e=o.state.foldGutter;e&&(o.operation(function(){i(o,t.from,t.to)}),e.from=t.from,e.to=t.to)}function d(o,t,e){var n=o.state.foldGutter;if(n){var i=n.options;if(e==i.gutter){var f=r(o,t);f?f.clear():o.foldCode(c(t,0),i.rangeFinder)}}}function a(o){var t=o.state.foldGutter;if(t){var e=t.options;t.from=t.to=0,clearTimeout(t.changeUpdate),t.changeUpdate=setTimeout(function(){f(o)},e.foldOnChangeTimeSpan||600)}}function u(o){var t=o.state.foldGutter;if(t){var e=t.options;clearTimeout(t.changeUpdate),t.changeUpdate=setTimeout(function(){var e=o.getViewport();t.from==t.to||e.from-t.to>20||t.from-e.to>20?f(o):o.operation(function(){e.from<t.from&&(i(o,e.from,t.from),t.from=e.from),e.to>t.to&&(i(o,t.to,e.to),t.to=e.to)})},e.updateViewportTimeSpan||400)}}function l(o,t){var e=o.state.foldGutter;if(e){var r=t.line;r>=e.from&&r<e.to&&i(o,r,r+1)}}o.defineOption("foldGutter",!1,function(r,n,i){i&&i!=o.Init&&(r.clearGutter(r.state.foldGutter.options.gutter),r.state.foldGutter=null,r.off("gutterClick",d),r.off("change",a),r.off("viewportChange",u),r.off("fold",l),r.off("unfold",l),r.off("swapDoc",f)),n&&(r.state.foldGutter=new t(e(n)),f(r),r.on("gutterClick",d),r.on("change",a),r.on("viewportChange",u),r.on("fold",l),r.on("unfold",l),r.on("swapDoc",f))});var c=o.Pos});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZlbmRvci9jb2RlbWlycm9yL2ZvbGRndXR0ZXIuanMiXSwibmFtZXMiOlsibW9kIiwiZXhwb3J0cyIsIm1vZHVsZSIsInJlcXVpcmUiLCJkZWZpbmUiLCJhbWQiLCJDb2RlTWlycm9yIiwiU3RhdGUiLCJvcHRpb25zIiwidGhpcyIsImZyb20iLCJ0byIsInBhcnNlT3B0aW9ucyIsIm9wdHMiLCJndXR0ZXIiLCJpbmRpY2F0b3JPcGVuIiwiaW5kaWNhdG9yRm9sZGVkIiwiaXNGb2xkZWQiLCJjbSIsImxpbmUiLCJtYXJrcyIsImZpbmRNYXJrc0F0IiwiUG9zIiwiaSIsImxlbmd0aCIsIl9faXNGb2xkIiwiZmluZCIsIm1hcmtlciIsInNwZWMiLCJlbHQiLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJjbGFzc05hbWUiLCJjbG9uZU5vZGUiLCJ1cGRhdGVGb2xkSW5mbyIsInN0YXRlIiwiZm9sZEd1dHRlciIsImN1ciIsIm1pblNpemUiLCJmb2xkT3B0aW9uIiwiZnVuYyIsImVhY2hMaW5lIiwibWFyayIsInBvcyIsInJhbmdlIiwic2V0R3V0dGVyTWFya2VyIiwidXBkYXRlSW5WaWV3cG9ydCIsInZwIiwiZ2V0Vmlld3BvcnQiLCJvcGVyYXRpb24iLCJvbkd1dHRlckNsaWNrIiwiZm9sZGVkIiwiY2xlYXIiLCJmb2xkQ29kZSIsInJhbmdlRmluZGVyIiwib25DaGFuZ2UiLCJjbGVhclRpbWVvdXQiLCJjaGFuZ2VVcGRhdGUiLCJzZXRUaW1lb3V0IiwiZm9sZE9uQ2hhbmdlVGltZVNwYW4iLCJvblZpZXdwb3J0Q2hhbmdlIiwidXBkYXRlVmlld3BvcnRUaW1lU3BhbiIsIm9uRm9sZCIsImRlZmluZU9wdGlvbiIsInZhbCIsIm9sZCIsIkluaXQiLCJjbGVhckd1dHRlciIsIm9mZiIsIm9uIl0sIm1hcHBpbmdzIjoiQ0FHQSxTQUFVQSxHQUNjLGdCQUFYQyxVQUF3QyxnQkFBVkMsUUFDdkNGLEVBQUlHLFFBQVEsd0JBQXlCQSxRQUFRLGVBQ3JCLGtCQUFW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aEJrQixJQUNGOUMsRUFBR2lCLE1BQU1DLFdBQWEsR0FBSTdCLEdBQU1LLEVBQWFvRCxJQUM3Q2xCLEVBQWlCNUIsR0FDakJBLEVBQUdtRCxHQUFHLGNBQWVuQixHQUNyQmhDLEVBQUdtRCxHQUFHLFNBQVVkLEdBQ2hCckMsRUFBR21ELEdBQUcsaUJBQWtCVCxHQUN4QjFDLEVBQUdtRCxHQUFHLE9BQVFQLEdBQ2Q1QyxFQUFHbUQsR0FBRyxTQUFVUCxHQUNoQjVDLEVBQUdtRCxHQUFHLFVBQVd2QixLQUlyQixJQUFJeEIsR0FBTWhCLEVBQVdnQiIsImZpbGUiOiJ2ZW5kb3IvY29kZW1pcnJvci9mb2xkZ3V0dGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29kZU1pcnJvciwgY29weXJpZ2h0IChjKSBieSBNYXJpam4gSGF2ZXJiZWtlIGFuZCBvdGhlcnNcbi8vIERpc3RyaWJ1dGVkIHVuZGVyIGFuIE1JVCBsaWNlbnNlOiBodHRwOi8vY29kZW1pcnJvci5uZXQvTElDRU5TRVxuXG4oZnVuY3Rpb24obW9kKSB7XG4gIGlmICh0eXBlb2YgZXhwb3J0cyA9PSBcIm9iamVjdFwiICYmIHR5cGVvZiBtb2R1bGUgPT0gXCJvYmplY3RcIikgLy8gQ29tbW9uSlNcbiAgICBtb2QocmVxdWlyZShcIi4uLy4uL2xpYi9jb2RlbWlycm9yXCIpLCByZXF1aXJlKFwiLi9mb2xkY29kZVwiKSk7XG4gIGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT0gXCJmdW5jdGlvblwiICYmIGRlZmluZS5hbWQpIC8vIEFNRFxuICAgIGRlZmluZShbXCIuLi8uLi9saWIvY29kZW1pcnJvclwiLCBcIi4vZm9sZGNvZGVcIl0sIG1vZCk7XG4gIGVsc2UgLy8gUGxhaW4gYnJvd3NlciBlbnZcbiAgICBtb2QoQ29kZU1pcnJvcik7XG59KShmdW5jdGlvbihDb2RlTWlycm9yKSB7XG4gIFwidXNlIHN0cmljdFwiO1xuXG4gIENvZGVNaXJyb3IuZGVmaW5lT3B0aW9uKFwiZm9sZEd1dHRlclwiLCBmYWxzZSwgZnVuY3Rpb24oY20sIHZhbCwgb2xkKSB7XG4gICAgaWYgKG9sZCAmJiBvbGQgIT0gQ29kZU1pcnJvci5Jbml0KSB7XG4gICAgICBjbS5jbGVhckd1dHRlcihjbS5zdGF0ZS5mb2xkR3V0dGVyLm9wdGlvbnMuZ3V0dGVyKTtcbiAgICAgIGNtLnN0YXRlLmZvbGRHdXR0ZXIgPSBudWxsO1xuICAgICAgY20ub2ZmKFwiZ3V0dGVyQ2xpY2tcIiwgb25HdXR0ZXJDbGljayk7XG4gICAgICBjbS5vZmYoXCJjaGFuZ2VcIiwgb25DaGFuZ2UpO1xuICAgICAgY20ub2ZmKFwidmlld3BvcnRDaGFuZ2VcIiwgb25WaWV3cG9ydENoYW5nZSk7XG4gICAgICBjbS5vZmYoXCJmb2xkXCIsIG9uRm9sZCk7XG4gICAgICBjbS5vZmYoXCJ1bmZvbGRcIiwgb25Gb2xkKTtcbiAgICAgIGNtLm9mZihcInN3YXBEb2NcIiwgdXBkYXRlSW5WaWV3cG9ydCk7XG4gICAgfVxuICAgIGlmICh2YWwpIHtcbiAgICAgIGNtLnN0YXRlLmZvbGRHdXR0ZXIgPSBuZXcgU3RhdGUocGFyc2VPcHRpb25zKHZhbCkpO1xuICAgICAgdXBkYXRlSW5WaWV3cG9ydChjbSk7XG4gICAgICBjbS5vbihcImd1dHRlckNsaWNrXCIsIG9uR3V0dGVyQ2xpY2spO1xuICAgICAgY20ub24oXCJjaGFuZ2VcIiwgb25DaGFuZ2UpO1xuICAgICAgY20ub24oXCJ2aWV3cG9ydENoYW5nZVwiLCBvblZpZXdwb3J0Q2hhbmdlKTtcbiAgICAgIGNtLm9uKFwiZm9sZFwiLCBvbkZvbGQpO1xuICAgICAgY20ub24oXCJ1bmZvbGRcIiwgb25Gb2xkKTtcbiAgICAgIGNtLm9uKFwic3dhcERvY1wiLCB1cGRhdGVJblZpZXdwb3J0KTtcbiAgICB9XG4gIH0pO1xuXG4gIHZhciBQb3MgPSBDb2RlTWlycm9yLlBvcztcblxuICBmdW5jdGlvbiBTdGF0ZShvcHRpb25zKSB7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcbiAgICB0aGlzLmZyb20gPSB0aGlzLnRvID0gMDtcbiAgfVxuXG4gIGZ1bmN0aW9uIHBhcnNlT3B0aW9ucyhvcHRzKSB7XG4gICAgaWYgKG9wdHMgPT09IHRydWUpIG9wdHMgPSB7fTtcbiAgICBpZiAob3B0cy5ndXR0ZXIgPT0gbnVsbCkgb3B0cy5ndXR0ZXIgPSBcIkNvZGVNaXJyb3ItZm9sZGd1dHRlclwiO1xuICAgIGlmIChvcHRzLmluZGljYXRvck9wZW4gPT0gbnVsbCkgb3B0cy5pbmRpY2F0b3JPcGVuID0gXCJDb2RlTWlycm9yLWZvbGRndXR0ZXItb3BlblwiO1xuICAgIGlmIChvcHRzLmluZGljYXRvckZvbGRlZCA9PSBudWxsKSBvcHRzLmluZGljYXRvckZvbGRlZCA9IFwiQ29kZU1pcnJvci1mb2xkZ3V0dGVyLWZvbGRlZFwiO1xuICAgIHJldHVybiBvcHRzO1xuICB9XG5cbiAgZnVuY3Rpb24gaXNGb2xkZWQoY20sIGxpbmUpIHtcbiAgICB2YXIgbWFya3MgPSBjbS5maW5kTWFya3NBdChQb3MobGluZSkpO1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWFya3MubGVuZ3RoOyArK2kpXG4gICAgICBpZiAobWFya3NbaV0uX19pc0ZvbGQgJiYgbWFya3NbaV0uZmluZCgpLmZyb20ubGluZSA9PSBsaW5lKSByZXR1cm4gbWFya3NbaV07XG4gIH1cblxuICBmdW5jdGlvbiBtYXJrZXIoc3BlYykge1xuICAgIGlmICh0eXBlb2Ygc3BlYyA9PSBcInN0cmluZ1wiKSB7XG4gICAgICB2YXIgZWx0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICAgIGVsdC5jbGFzc05hbWUgPSBzcGVjICsgXCIgQ29kZU1pcnJvci1ndXR0ZXJtYXJrZXItc3VidGxlXCI7XG4gICAgICByZXR1cm4gZWx0O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gc3BlYy5jbG9uZU5vZGUodHJ1ZSk7XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gdXBkYXRlRm9sZEluZm8oY20sIGZyb20sIHRvKSB7XG4gICAgdmFyIG9wdHMgPSBjbS5zdGF0ZS5mb2xkR3V0dGVyLm9wdGlvbnMsIGN1ciA9IGZyb207XG4gICAgdmFyIG1pblNpemUgPSBjbS5mb2xkT3B0aW9uKG9wdHMsIFwibWluRm9sZFNpemVcIik7XG4gICAgdmFyIGZ1bmMgPSBjbS5mb2xkT3B0aW9uKG9wdHMsIFwicmFuZ2VGaW5kZXJcIik7XG4gICAgY20uZWFjaExpbmUoZnJvbSwgdG8sIGZ1bmN0aW9uKGxpbmUpIHtcbiAgICAgIHZhciBtYXJrID0gbnVsbDtcbiAgICAgIGlmIChpc0ZvbGRlZChjbSwgY3VyKSkge1xuICAgICAgICBtYXJrID0gbWFya2VyKG9wdHMuaW5kaWNhdG9yRm9sZGVkKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciBwb3MgPSBQb3MoY3VyLCAwKTtcbiAgICAgICAgdmFyIHJhbmdlID0gZnVuYyAmJiBmdW5jKGNtLCBwb3MpO1xuICAgICAgICBpZiAocmFuZ2UgJiYgcmFuZ2UudG8ubGluZSAtIHJhbmdlLmZyb20ubGluZSA+PSBtaW5TaXplKVxuICAgICAgICAgIG1hcmsgPSBtYXJrZXIob3B0cy5pbmRpY2F0b3JPcGVuKTtcbiAgICAgIH1cbiAgICAgIGNtLnNldEd1dHRlck1hcmtlcihsaW5lLCBvcHRzLmd1dHRlciwgbWFyayk7XG4gICAgICArK2N1cjtcbiAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHVwZGF0ZUluVmlld3BvcnQoY20pIHtcbiAgICB2YXIgdnAgPSBjbS5nZXRWaWV3cG9ydCgpLCBzdGF0ZSA9IGNtLnN0YXRlLmZvbGRHdXR0ZXI7XG4gICAgaWYgKCFzdGF0ZSkgcmV0dXJuO1xuICAgIGNtLm9wZXJhdGlvbihmdW5jdGlvbigpIHtcbiAgICAgIHVwZGF0ZUZvbGRJbmZvKGNtLCB2cC5mcm9tLCB2cC50byk7XG4gICAgfSk7XG4gICAgc3RhdGUuZnJvbSA9IHZwLmZyb207IHN0YXRlLnRvID0gdnAudG87XG4gIH1cblxuICBmdW5jdGlvbiBvbkd1dHRlckNsaWNrKGNtLCBsaW5lLCBndXR0ZXIpIHtcbiAgICB2YXIgc3RhdGUgPSBjbS5zdGF0ZS5mb2xkR3V0dGVyO1xuICAgIGlmICghc3RhdGUpIHJldHVybjtcbiAgICB2YXIgb3B0cyA9IHN0YXRlLm9wdGlvbnM7XG4gICAgaWYgKGd1dHRlciAhPSBvcHRzLmd1dHRlcikgcmV0dXJuO1xuICAgIHZhciBmb2xkZWQgPSBpc0ZvbGRlZChjbSwgbGluZSk7XG4gICAgaWYgKGZvbGRlZCkgZm9sZGVkLmNsZWFyKCk7XG4gICAgZWxzZSBjbS5mb2xkQ29kZShQb3MobGluZSwgMCksIG9wdHMucmFuZ2VGaW5kZXIpO1xuICB9XG5cbiAgZnVuY3Rpb24gb25DaGFuZ2UoY20pIHtcbiAgICB2YXIgc3RhdGUgPSBjbS5zdGF0ZS5mb2xkR3V0dGVyO1xuICAgIGlmICghc3RhdGUpIHJldHVybjtcbiAgICB2YXIgb3B0cyA9IHN0YXRlLm9wdGlvbnM7XG4gICAgc3RhdGUuZnJvbSA9IHN0YXRlLnRvID0gMDtcbiAgICBjbGVhclRpbWVvdXQoc3RhdGUuY2hhbmdlVXBkYXRlKTtcbiAgICBzdGF0ZS5jaGFuZ2VVcGRhdGUgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyB1cGRhdGVJblZpZXdwb3J0KGNtKTsgfSwgb3B0cy5mb2xkT25DaGFuZ2VUaW1lU3BhbiB8fCA2MDApO1xuICB9XG5cbiAgZnVuY3Rpb24gb25WaWV3cG9ydENoYW5nZShjbSkge1xuICAgIHZhciBzdGF0ZSA9IGNtLnN0YXRlLmZvbGRHdXR0ZXI7XG4gICAgaWYgKCFzdGF0ZSkgcmV0dXJuO1xuICAgIHZhciBvcHRzID0gc3RhdGUub3B0aW9ucztcbiAgICBjbGVhclRpbWVvdXQoc3RhdGUuY2hhbmdlVXBkYXRlKTtcbiAgICBzdGF0ZS5jaGFuZ2VVcGRhdGUgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIHZwID0gY20uZ2V0Vmlld3BvcnQoKTtcbiAgICAgIGlmIChzdGF0ZS5mcm9tID09IHN0YXRlLnRvIHx8IHZwLmZyb20gLSBzdGF0ZS50byA+IDIwIHx8IHN0YXRlLmZyb20gLSB2cC50byA+IDIwKSB7XG4gICAgICAgIHVwZGF0ZUluVmlld3BvcnQoY20pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY20ub3BlcmF0aW9uKGZ1bmN0aW9uKCkge1xuICAgICAgICAgIGlmICh2cC5mcm9tIDwgc3RhdGUuZnJvbSkge1xuICAgICAgICAgICAgdXBkYXRlRm9sZEluZm8oY20sIHZwLmZyb20sIHN0YXRlLmZyb20pO1xuICAgICAgICAgICAgc3RhdGUuZnJvbSA9IHZwLmZyb207XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh2cC50byA+IHN0YXRlLnRvKSB7XG4gICAgICAgICAgICB1cGRhdGVGb2xkSW5mbyhjbSwgc3RhdGUudG8sIHZwLnRvKTtcbiAgICAgICAgICAgIHN0YXRlLnRvID0gdnAudG87XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9LCBvcHRzLnVwZGF0ZVZpZXdwb3J0VGltZVNwYW4gfHwgNDAwKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG9uRm9sZChjbSwgZnJvbSkge1xuICAgIHZhciBzdGF0ZSA9IGNtLnN0YXRlLmZvbGRHdXR0ZXI7XG4gICAgaWYgKCFzdGF0ZSkgcmV0dXJuO1xuICAgIHZhciBsaW5lID0gZnJvbS5saW5lO1xuICAgIGlmIChsaW5lID49IHN0YXRlLmZyb20gJiYgbGluZSA8IHN0YXRlLnRvKVxuICAgICAgdXBkYXRlRm9sZEluZm8oY20sIGxpbmUsIGxpbmUgKyAxKTtcbiAgfVxufSk7XG4iXX0=
